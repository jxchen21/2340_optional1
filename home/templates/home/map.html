{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid p-0">
    <!-- Map Header -->
    <div class="bg-dark text-white py-4">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2">
                        <i class="fas fa-map-marked-alt me-2"></i>
                        Local Popularity Map
                    </h1>
                    <p class="mb-0">Discover popular movies in your area</p>
                </div>
                <div class="col-md-4 text-end">
                    {% if user_location %}
                        <div class="location-info">
                            <small class="text-muted">Current Location:</small>
                            <div class="fw-bold">{{ user_location.city }}, {{ user_location.country }}</div>
                        </div>
                    {% else %}
                        <div class="location-info">
                            <small class="text-muted">Location not set</small>
                            <div class="fw-bold">Enable location to see local data</div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Map Container -->
    <div class="position-relative">
        <div id="map" style="height: 70vh; width: 100%;"></div>

        <!-- Map Controls -->
        <div class="position-absolute top-0 end-0 p-3">
            <div class="card shadow">
                <div class="card-body p-2">
                    <button id="getLocationBtn" class="btn btn-primary btn-sm">
                        <i class="fas fa-location-arrow me-1"></i>
                        Get My Location
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="position-absolute top-50 start-50 translate-middle text-center" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2 text-white">Loading map...</div>
        </div>
    </div>

    <!-- Trending Movies Panel -->
    <div class="bg-light py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <h5 id="trending-title">
                        {% if user_trending_movies %}
                            Trending Movies in {{ user_location.city }}, {{ user_location.country }}
                        {% else %}
                            Select a region on the map to see trending movies
                        {% endif %}
                    </h5>
                    <div id="trending-movies-list">
                        {% if user_trending_movies %}
                            <div class="row">
                                {% for movie_popularity in user_trending_movies %}
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="card h-100">
                                        {% if movie_popularity.movie.image %}
                                        <img src="{{ movie_popularity.movie.image.url }}" class="card-img-top" style="height: 200px; object-fit: cover;" alt="{{ movie_popularity.movie.name }}">
                                        {% endif %}
                                        <div class="card-body">
                                            <h6 class="card-title">{{ movie_popularity.movie.name }}</h6>
                                            <p class="card-text">
                                                <span class="badge bg-primary">{{ movie_popularity.purchase_count }} purchases</span>
                                                <br>
                                                <small class="text-muted">${{ movie_popularity.movie.price }}</small>
                                            </p>
                                            <a href="{% url 'movies.show' id=movie_popularity.movie.id %}" class="btn btn-sm btn-outline-primary">View Details</a>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted">Click on a region marker on the map to see trending movies in that area.</p>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <h5>How it works</h5>
                    <p class="text-muted">
                        This map shows popular movies based on purchase data in different locations.
                        Click on region markers to see trending movies in that area.
                    </p>
                    <h6>Features</h6>
                    <ul class="text-muted">
                        <li>View local movie popularity</li>
                        <li>Discover trending movies by region</li>
                        <li>Compare popularity across regions</li>
                        <li>Real-time location tracking</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Google Maps API -->
<script>
    let map;
    let userMarker;
    let userLocation = {% if user_location %}{{ user_location|safe }}{% else %}null{% endif %};
    let regionalData = {{ regional_data|safe }};
    let regionMarkers = [];

    function initMap() {
        console.log('initMap called');
        console.log('userLocation:', userLocation);
        console.log('regionalData:', regionalData);
        
        // Check if map container exists
        const mapElement = document.getElementById("map");
        if (!mapElement) {
            console.error('Map container not found!');
            return;
        }
        
        // Default center (Tokyo, Japan - based on footer contact info)
        const defaultCenter = { lat: 35.6762, lng: 139.6503 };

        // Use user location if available, otherwise use default
        const center = userLocation ? { lat: userLocation.lat, lng: userLocation.lng } : defaultCenter;

        try {
            map = new google.maps.Map(mapElement, {
                zoom: 12,
                center: center,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });
            console.log('Map initialized successfully');

            // Add user location marker if available
            if (userLocation) {
                addUserMarker(userLocation.lat, userLocation.lng, userLocation.city);
            }

            // Add regional movie popularity markers
            addRegionalMarkers();
        } catch (error) {
            console.error('Error initializing map:', error);
        }
    }

    function addUserMarker(lat, lng, city) {
        userMarker = new google.maps.Marker({
            position: { lat: lat, lng: lng },
            map: map,
            title: `Your location: ${city}`,
            icon: {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="16" cy="16" r="12" fill="#007bff" stroke="#fff" stroke-width="3"/>
                        <circle cx="16" cy="16" r="6" fill="#fff"/>
                    </svg>
                `),
                scaledSize: new google.maps.Size(32, 32)
            }
        });

        const infoWindow = new google.maps.InfoWindow({
            content: `
                <div class="p-2">
                    <h6 class="mb-1">Your Location</h6>
                    <p class="mb-0 text-muted">${city}</p>
                </div>
            `
        });

        userMarker.addListener("click", () => {
            infoWindow.open(map, userMarker);
        });
    }

    function addRegionalMarkers() {
        console.log('addRegionalMarkers called');
        console.log('regionalData:', regionalData);
        
        // Clear existing region markers
        regionMarkers.forEach(marker => marker.setMap(null));
        regionMarkers = [];

        if (regionalData && regionalData.length > 0) {
            console.log('Adding regional markers for', regionalData.length, 'regions');
            regionalData.forEach((region, index) => {
                const marker = new google.maps.Marker({
                    position: { lat: region.latitude, lng: region.longitude },
                    map: map,
                    title: `${region.region_name}, ${region.country}`,
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg width="28" height="28" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="14" cy="14" r="12" fill="#dc3545" stroke="#fff" stroke-width="2"/>
                                <text x="14" y="18" text-anchor="middle" fill="white" font-size="10" font-weight="bold">ðŸŽ¬</text>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(28, 28)
                    }
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div class="p-2">
                            <h6 class="mb-1">${region.region_name}, ${region.country}</h6>
                            <p class="mb-2 text-muted">Click to see trending movies</p>
                            <button class="btn btn-sm btn-primary" onclick="loadTrendingMovies('${region.region_name}', '${region.country}')">
                                View Trending Movies
                            </button>
                        </div>
                    `
                });

                marker.addListener("click", () => {
                    infoWindow.open(map, marker);
                    loadTrendingMovies(region.region_name, region.country);
                });

                regionMarkers.push(marker);
            });
        } else {
            console.log('No regional data found, adding sample markers');
            // Add some sample markers if no real data exists
            addSampleMarkers();
        }
    }

    function addSampleMarkers() {
        // Sample markers for demonstration when no real data exists
        const sampleLocations = [
            { lat: 35.6762, lng: 139.6503, title: "Tokyo", country: "Japan" },
            { lat: 40.7128, lng: -74.0060, title: "New York", country: "USA" },
            { lat: 51.5074, lng: -0.1278, title: "London", country: "UK" },
            { lat: 48.8566, lng: 2.3522, title: "Paris", country: "France" }
        ];

        sampleLocations.forEach((location, index) => {
            const marker = new google.maps.Marker({
                position: { lat: location.lat, lng: location.lng },
                map: map,
                title: `${location.title}, ${location.country}`,
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" fill="#6c757d" stroke="#fff" stroke-width="2"/>
                            <text x="12" y="16" text-anchor="middle" fill="white" font-size="8" font-weight="bold">?</text>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(24, 24)
                }
            });

            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div class="p-2">
                        <h6 class="mb-1">${location.title}, ${location.country}</h6>
                        <p class="mb-2 text-muted">No movie data available yet</p>
                        <small class="text-muted">Purchase movies to see trending data here</small>
                    </div>
                `
            });

            marker.addListener("click", () => {
                infoWindow.open(map, marker);
            });

            regionMarkers.push(marker);
        });
    }

    function getCurrentLocation() {
        if (navigator.geolocation) {
            document.getElementById('loadingOverlay').style.display = 'block';

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;

                    // Update map center
                    map.setCenter({ lat: lat, lng: lng });
                    map.setZoom(15);

                    // Remove existing user marker
                    if (userMarker) {
                        userMarker.setMap(null);
                    }

                    // Add new user marker
                    addUserMarker(lat, lng, "Current Location");

                    // Update location in database
                    updateUserLocation(lat, lng);

                    document.getElementById('loadingOverlay').style.display = 'none';
                },
                function(error) {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    alert('Error getting location: ' + error.message);
                }
            );
        } else {
            alert('Geolocation is not supported by this browser.');
        }
    }

    function updateUserLocation(lat, lng) {
        // Use reverse geocoding to get city and country
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ location: { lat: lat, lng: lng } }, function(results, status) {
            let city = 'Unknown';
            let country = 'Unknown';

            if (status === 'OK' && results[0]) {
                const addressComponents = results[0].address_components;
                for (let component of addressComponents) {
                    if (component.types.includes('locality')) {
                        city = component.long_name;
                    }
                    if (component.types.includes('country')) {
                        country = component.long_name;
                    }
                }
            }

            // Send location data to server
            fetch('{% url "home.update_location" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    lat: lat,
                    lng: lng,
                    city: city,
                    country: country
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the location info display
                    const locationInfo = document.querySelector('.location-info');
                    if (locationInfo) {
                        locationInfo.innerHTML = `
                            <small class="text-muted">Current Location:</small>
                            <div class="fw-bold">${city}, ${country}</div>
                        `;
                    }
                    alert('Location updated successfully!');
                } else {
                    alert('Error updating location: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating location');
            });
        });
    }

    function loadTrendingMovies(regionName, country) {
        // Show loading state
        document.getElementById('trending-title').innerHTML = `Loading trending movies in ${regionName}...`;
        document.getElementById('trending-movies-list').innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';

        // Fetch trending movies for the region
        fetch(`{% url 'home.region_trending_movies' %}?region=${encodeURIComponent(regionName)}&country=${encodeURIComponent(country)}`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateTrendingMoviesDisplay(data);
            } else {
                showNoMoviesMessage(regionName, country, data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNoMoviesMessage(regionName, country, 'Error loading trending movies');
        });
    }

    function updateTrendingMoviesDisplay(data) {
        const titleElement = document.getElementById('trending-title');
        const listElement = document.getElementById('trending-movies-list');

        titleElement.innerHTML = `Trending Movies in ${data.region}, ${data.country}`;

        if (data.trending_movies && data.trending_movies.length > 0) {
            let moviesHTML = '<div class="row">';
            data.trending_movies.forEach(movie => {
                moviesHTML += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100">
                            ${movie.movie_image ? `<img src="${movie.movie_image}" class="card-img-top" style="height: 200px; object-fit: cover;" alt="${movie.movie_name}">` : ''}
                            <div class="card-body">
                                <h6 class="card-title">${movie.movie_name}</h6>
                                <p class="card-text">
                                    <span class="badge bg-primary">${movie.purchase_count} purchases</span>
                                    <br>
                                    <small class="text-muted">$${movie.movie_price}</small>
                                </p>
                                <a href="/movies/${movie.movie_id}/" class="btn btn-sm btn-outline-primary">View Details</a>
                            </div>
                        </div>
                    </div>
                `;
            });
            moviesHTML += '</div>';
            listElement.innerHTML = moviesHTML;
        } else {
            showNoMoviesMessage(data.region, data.country, 'No trending movies found');
        }
    }

    function showNoMoviesMessage(regionName, country, message) {
        document.getElementById('trending-title').innerHTML = `Trending Movies in ${regionName}, ${country}`;
        document.getElementById('trending-movies-list').innerHTML = `
            <div class="alert alert-info" role="alert">
                <h6 class="alert-heading">No trending movies found</h6>
                <p class="mb-0">${message}</p>
                <hr>
                <p class="mb-0">Purchase movies to see trending data in this region.</p>
            </div>
        `;
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Event listeners
    document.getElementById('getLocationBtn').addEventListener('click', getCurrentLocation);

    // Initialize map when page loads
    window.initMap = initMap;
    
    // Test if Google Maps API is loaded
    window.addEventListener('load', function() {
        console.log('Page loaded, checking Google Maps API...');
        if (typeof google !== 'undefined' && google.maps) {
            console.log('Google Maps API is loaded');
        } else {
            console.error('Google Maps API is not loaded!');
        }
    });
</script>

<!-- Load Google Maps API -->
{% if google_maps_api_key %}
<script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap">
</script>
{% else %}
<div class="alert alert-warning" role="alert">
    <h4 class="alert-heading">API Key Required</h4>
    <p>Google Maps API key is not configured. Please add your API key to the environment variables.</p>
    <hr>
    <p class="mb-0">Create a <code>.env</code> file in your project root with: <code>GOOGLE_MAPS_API_KEY=your_api_key_here</code></p>
</div>
{% endif %}

<style>
    .location-info {
        background: rgba(255, 255, 255, 0.1);
        padding: 8px 12px;
        border-radius: 6px;
        backdrop-filter: blur(10px);
    }

    #map {
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        min-height: 400px;
        background-color: #f0f0f0;
    }

    .card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
    }
</style>
{% endblock %}
